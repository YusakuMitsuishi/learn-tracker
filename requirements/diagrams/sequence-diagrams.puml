@startuml ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ - TODOç™»éŒ²ã¨é€²æ—è¨˜éŒ²

skinparam backgroundColor #FAFAFA
skinparam sequenceMessageAlign center

title TODOç™»éŒ²ã¨é€²æ—è¨˜éŒ²ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

actor User as user
participant "React App" as react
participant "Redux Store" as redux
participant "API Client" as api
participant "Express API" as express
participant "Todo Service" as service
database "MongoDB" as db
database "Redis" as cache

== TODOç™»éŒ²ãƒ•ãƒ­ãƒ¼ ==

user -> react : TODOä½œæˆãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›
activate react

react -> react : ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
react -> redux : dispatch(createTodo)
activate redux

redux -> api : POST /api/todos
activate api

api -> express : HTTP Request
activate express

express -> express : èªè¨¼ãƒã‚§ãƒƒã‚¯
express -> express : ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
express -> service : createTodo(data)
activate service

service -> db : todos.insert()
activate db
db --> service : ä¿å­˜å®Œäº†
deactivate db

service -> cache : ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
activate cache
cache --> service : OK
deactivate cache

service --> express : Created Todo
deactivate service

express --> api : 201 Created + Todo
deactivate express

api --> redux : Success Response
deactivate api

redux -> redux : çŠ¶æ…‹æ›´æ–°
redux --> react : æ›´æ–°å®Œäº†
deactivate redux

react -> react : UIæ›´æ–°
react --> user : TODOä½œæˆå®Œäº†è¡¨ç¤º
deactivate react

== é€²æ—è¨˜éŒ²ãƒ•ãƒ­ãƒ¼ ==

user -> react : é€²æ—å€¤ã‚’å…¥åŠ›
activate react

react -> redux : dispatch(recordProgress)
activate redux

redux -> api : POST /api/progress
activate api

api -> express : HTTP Request
activate express

express -> express : èªè¨¼ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
express -> service : recordProgress(data)
activate service

service -> db : progress.insert()
activate db
db --> service : ä¿å­˜å®Œäº†
deactivate db

service -> db : todos.update(currentValue)
activate db
db --> service : æ›´æ–°å®Œäº†
deactivate db

service -> service : ç›®æ¨™é”æˆåˆ¤å®š
alt ç›®æ¨™é”æˆ
    service -> service : å®Ÿç¸¾ãƒã‚§ãƒƒã‚¯
    service -> db : achievements.update()
    activate db
    db --> service : å®Ÿç¸¾è§£é™¤
    deactivate db
end

service -> cache : çµ±è¨ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
activate cache
cache --> service : OK
deactivate cache

service --> express : Success + Achievement
deactivate service

express --> api : 200 OK + Data
deactivate express

api --> redux : Success Response
deactivate api

redux -> redux : çŠ¶æ…‹æ›´æ–°
redux --> react : æ›´æ–°å®Œäº†
deactivate redux

alt ç›®æ¨™é”æˆ or å®Ÿç¸¾è§£é™¤
    react -> react : æ¼”å‡ºãƒˆãƒªã‚¬ãƒ¼
    react --> user : ç¥ç¦æ¼”å‡ºè¡¨ç¤º ğŸ‰
else é€šå¸¸è¨˜éŒ²
    react --> user : é€²æ—è¨˜éŒ²å®Œäº†
end

deactivate react

@enduml

@startuml ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ - ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ç”»é¢åˆ‡ã‚Šæ›¿ãˆ

skinparam backgroundColor #FAFAFA
skinparam sequenceMessageAlign center

title ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ - è‡ªå‹•ç”»é¢åˆ‡ã‚Šæ›¿ãˆ

actor User as user
participant "Display Container" as display
participant "Redux Store" as redux
participant "API Client" as api
participant "Express API" as express
database "MongoDB" as db
database "Redis" as cache

user -> display : ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
activate display

display -> redux : dispatch(startDisplayMode)
activate redux

redux -> redux : isAutoPlay = true
redux --> display : ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
deactivate redux

loop 10ç§’é–“éš”ï¼ˆè¨­å®šå¯èƒ½ï¼‰
    display -> display : ç”»é¢åˆ‡ã‚Šæ›¿ãˆã‚¿ã‚¤ãƒãƒ¼

    alt ç”»é¢1: æœ¬æ—¥ã®TODOãƒªã‚¹ãƒˆ
        display -> redux : getTodayTodos()
        activate redux
        redux -> api : GET /api/todos/today
        activate api
        api -> express : HTTP Request
        activate express

        express -> cache : ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
        activate cache
        alt ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ
            cache --> express : ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿
        else ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹
            deactivate cache
            express -> db : todos.find({userId, date: today})
            activate db
            db --> express : Todo[]
            deactivate db
            express -> cache : ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
            activate cache
            cache --> express : OK
            deactivate cache
        end

        express --> api : 200 OK + Todos
        deactivate express
        api --> redux : Success
        deactivate api
        redux --> display : TODO ãƒ‡ãƒ¼ã‚¿
        deactivate redux
        display -> display : TODO ãƒªã‚¹ãƒˆè¡¨ç¤º
        display --> user : æœ¬æ—¥ã®TODOè¡¨ç¤º

    else ç”»é¢2: é€²æ—çŠ¶æ³
        display -> redux : getTodayProgress()
        activate redux
        redux -> api : GET /api/progress/date/:today
        activate api
        api -> express : HTTP Request
        activate express
        express -> db : progress.find()
        activate db
        db --> express : Progress[]
        deactivate db
        express --> api : 200 OK + Progress
        deactivate express
        api --> redux : Success
        deactivate api
        redux --> display : é€²æ—ãƒ‡ãƒ¼ã‚¿
        deactivate redux
        display -> display : ã‚°ãƒ©ãƒ•æç”»
        display --> user : é€²æ—ã‚°ãƒ©ãƒ•è¡¨ç¤º ğŸ“Š

    else ç”»é¢3: ç¶™ç¶šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
        display -> redux : getStreakData()
        activate redux
        redux -> api : GET /api/stats/streak
        activate api
        api -> express : HTTP Request
        activate express

        express -> cache : streak:{userId}
        activate cache
        alt ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Š
            cache --> express : Streak Data
        else ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—
            deactivate cache
            express -> db : stats.aggregate()
            activate db
            db --> express : é›†è¨ˆçµæœ
            deactivate db
            express -> cache : ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
            activate cache
            cache --> express : OK
            deactivate cache
        end

        express --> api : 200 OK + Streak
        deactivate express
        api --> redux : Success
        deactivate api
        redux --> display : ç¶™ç¶šãƒ‡ãƒ¼ã‚¿
        deactivate redux
        display -> display : ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æç”»
        display --> user : ç¶™ç¶šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º ğŸ“…

    else ç”»é¢4: çµ±è¨ˆãƒ»ãƒ¬ãƒãƒ¼ãƒˆ
        display -> redux : getWeeklyStats()
        activate redux
        redux -> api : GET /api/stats/weekly
        activate api
        api -> express : HTTP Request
        activate express
        express -> db : stats.aggregate()
        activate db
        db --> express : é€±æ¬¡çµ±è¨ˆ
        deactivate db
        express --> api : 200 OK + Stats
        deactivate express
        api --> redux : Success
        deactivate api
        redux --> display : çµ±è¨ˆãƒ‡ãƒ¼ã‚¿
        deactivate redux
        display -> display : ãƒãƒ£ãƒ¼ãƒˆæç”»
        display --> user : é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º ğŸ“ˆ

    else ç”»é¢5: å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        display -> display : æ—¥æ›¿ã‚ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
        display -> display : ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ
        display --> user : åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º ğŸ’ª
    end

    display -> display : æ¬¡ã®ç”»é¢ã¸é·ç§»
end

user -> display : ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰çµ‚äº†
display -> redux : dispatch(stopDisplayMode)
activate redux
redux -> redux : isAutoPlay = false
redux --> display : ãƒ¢ãƒ¼ãƒ‰çµ‚äº†
deactivate redux

display --> user : é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã¸æˆ»ã‚‹
deactivate display

@enduml

@startuml ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ - å®Ÿç¸¾è§£é™¤ã¨æ¼”å‡º

skinparam backgroundColor #FAFAFA
skinparam sequenceMessageAlign center

title å®Ÿç¸¾ï¼ˆAchievementï¼‰è§£é™¤ã¨æ¼”å‡ºãƒ•ãƒ­ãƒ¼

actor User as user
participant "React App" as react
participant "Achievement Service\n(Frontend)" as achFront
participant "API Client" as api
participant "Express API" as express
participant "Achievement Service\n(Backend)" as achBack
database "MongoDB" as db
participant "Notification Service" as notify
participant "Celebration Component" as celebration

user -> react : é€²æ—è¨˜éŒ²å®Œäº†
activate react

react -> api : POST /api/progress
activate api

api -> express : HTTP Request
activate express

express -> achBack : checkAchievements(userId, action)
activate achBack

achBack -> db : achievements.find({userId, unlocked: false})
activate db
db --> achBack : æœªè§£é™¤ã®å®Ÿç¸¾ãƒªã‚¹ãƒˆ
deactivate db

loop å„å®Ÿç¸¾ã®æ¡ä»¶ãƒã‚§ãƒƒã‚¯
    achBack -> achBack : æ¡ä»¶è©•ä¾¡

    alt 7æ—¥é€£ç¶šé”æˆ
        achBack -> db : stats.find({userId}).sort({date: -1}).limit(7)
        activate db
        db --> achBack : ç›´è¿‘7æ—¥åˆ†ã®çµ±è¨ˆ
        deactivate db
        achBack -> achBack : é€£ç¶šæ€§ãƒã‚§ãƒƒã‚¯

        alt 7æ—¥é€£ç¶šã§TODOé”æˆ
            achBack -> db : achievements.update({_id, unlocked: true})
            activate db
            db --> achBack : å®Ÿç¸¾è§£é™¤
            deactivate db
            achBack -> achBack : unlockedAchievements.push()
        end

    else ç´¯è¨ˆ100æ™‚é–“é”æˆ
        achBack -> db : progress.aggregate([{$match: {userId}}, {$group: {totalTime}}])
        activate db
        db --> achBack : ç´¯è¨ˆæ™‚é–“
        deactivate db

        alt ç´¯è¨ˆ100æ™‚é–“ä»¥ä¸Š
            achBack -> db : achievements.update()
            activate db
            db --> achBack : å®Ÿç¸¾è§£é™¤
            deactivate db
            achBack -> achBack : unlockedAchievements.push()
        end

    else ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆ
        achBack -> achBack : ç›®æ¨™å€¤ã¨å®Ÿç¸¾å€¤ã‚’æ¯”è¼ƒ

        alt ç›®æ¨™é”æˆ
            achBack -> db : achievements.update()
            activate db
            db --> achBack : å®Ÿç¸¾è§£é™¤
            deactivate db
            achBack -> achBack : unlockedAchievements.push()
        end
    end
end

alt å®Ÿç¸¾ãŒè§£é™¤ã•ã‚ŒãŸ
    achBack -> notify : scheduleNotification(achievement)
    activate notify
    notify -> db : notifications.insert()
    activate db
    db --> notify : é€šçŸ¥ä¿å­˜
    deactivate db
    notify --> achBack : é€šçŸ¥äºˆç´„å®Œäº†
    deactivate notify
end

achBack --> express : {progress, achievements: unlockedAchievements}
deactivate achBack

express --> api : 200 OK + Data
deactivate express

api --> react : Success Response
deactivate api

alt æ–°ã—ã„å®Ÿç¸¾ãŒè§£é™¤ã•ã‚ŒãŸ
    react -> achFront : processAchievements(achievements)
    activate achFront

    loop å„å®Ÿç¸¾
        achFront -> celebration : showCelebration(achievement)
        activate celebration

        celebration -> celebration : ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        celebration -> celebration : åŠ¹æœéŸ³å†ç”Ÿ ğŸµ
        celebration -> celebration : ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ğŸŠ

        celebration --> user : ã€ŒãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã€\nã€Œ7æ—¥é€£ç¶šé”æˆï¼ã€

        celebration -> celebration : ãƒãƒƒã‚¸è¡¨ç¤º
        celebration --> user : ãƒãƒƒã‚¸ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º ğŸ†

        par ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸¦åˆ—å®Ÿè¡Œ
            celebration -> celebration : ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆ
        and
            celebration -> celebration : ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        and
            celebration -> celebration : ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        end

        note right of celebration
          æ¼”å‡ºæ™‚é–“: ç´„5ç§’
          ï¼ˆè¨­å®šã§ã‚¹ã‚­ãƒƒãƒ—å¯èƒ½ï¼‰
        end note

        deactivate celebration
    end

    achFront --> react : æ¼”å‡ºå®Œäº†
    deactivate achFront
end

react --> user : é€šå¸¸ç”»é¢ã«æˆ»ã‚‹
deactivate react

@enduml

@startuml ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸ

skinparam backgroundColor #FAFAFA
skinparam sequenceMessageAlign center

title ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã¨ãƒ‡ãƒ¼ã‚¿åŒæœŸ

actor User as user
participant "React App" as react
participant "Redux Store" as redux
participant "IndexedDB" as idb
participant "Sync Middleware" as sync
participant "API Client" as api
participant "Express API" as express
database "MongoDB" as db

== ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®æ“ä½œ ==

user -> react : é€²æ—è¨˜éŒ²ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼‰
activate react

react -> redux : dispatch(recordProgress)
activate redux

redux -> sync : middlewareå‡¦ç†
activate sync

sync -> sync : ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
sync -> sync : isOnline = false

sync -> idb : pendingSync.add({type: 'progress', data})
activate idb
idb --> sync : ä¿å­˜å®Œäº†
deactivate idb

sync -> idb : progress.add(data)
activate idb
idb --> sync : ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å®Œäº†
deactivate idb

sync --> redux : ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜å®Œäº†
deactivate sync

redux -> redux : æ¥½è¦³çš„UIæ›´æ–°
redux --> react : æ›´æ–°å®Œäº†ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰
deactivate redux

react --> user : ã€Œã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ä¿å­˜ã—ã¾ã—ãŸã€\nã€Œã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ã«è‡ªå‹•åŒæœŸã—ã¾ã™ã€
deactivate react

== ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã®åŒæœŸ ==

react -> react : Online ã‚¤ãƒ™ãƒ³ãƒˆæ¤œçŸ¥
activate react

react -> sync : dispatch(syncPendingData)
activate sync

sync -> idb : pendingSync.getAll()
activate idb
idb --> sync : æœªåŒæœŸãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ
deactivate idb

loop å„æœªåŒæœŸãƒ‡ãƒ¼ã‚¿
    sync -> api : POST /api/progress
    activate api

    api -> express : HTTP Request
    activate express

    express -> express : ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—é‡è¤‡ãƒã‚§ãƒƒã‚¯

    alt ãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«å­˜åœ¨ï¼ˆä»–ãƒ‡ãƒã‚¤ã‚¹ã§åŒæœŸæ¸ˆã¿ï¼‰
        express --> api : 409 Conflict
        sync -> sync : ã‚¹ã‚­ãƒƒãƒ—
    else æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿
        express -> db : progress.insert()
        activate db
        db --> express : ä¿å­˜å®Œäº†
        deactivate db

        express --> api : 201 Created
        deactivate express

        api --> sync : Success
        deactivate api

        sync -> idb : pendingSync.delete(id)
        activate idb
        idb --> sync : å‰Šé™¤å®Œäº†
        deactivate idb
    end
end

sync -> api : GET /api/progress/sync?since={lastSyncTime}
activate api

api -> express : HTTP Request
activate express

express -> db : progress.find({updatedAt: {$gt: lastSyncTime}})
activate db
db --> express : ä»–ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®æ–°è¦ãƒ‡ãƒ¼ã‚¿
deactivate db

express --> api : 200 OK + Data
deactivate express

api --> sync : Success
deactivate api

sync -> idb : progress.bulkPut(newData)
activate idb
idb --> sync : ãƒ­ãƒ¼ã‚«ãƒ«DBæ›´æ–°å®Œäº†
deactivate idb

sync -> redux : dispatch(syncCompleted)
activate redux
redux -> redux : çŠ¶æ…‹ã‚’æœ€æ–°ã«æ›´æ–°
redux --> sync : å®Œäº†
deactivate redux

sync --> react : åŒæœŸå®Œäº†
deactivate sync

react --> user : ã€Œãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸã€âœ…
deactivate react

@enduml
